<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link rel="icon" href="favicon.png" type="image/png">
    <title>Other Colleges Registrations</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-black min-h-screen">
    <nav class="bg-yellow-400 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="flex space-x-7">
                    <div>
                        <a href="" class="flex items-center py-4 px-2">
                            <span class="font-semibold text-black text-lg">Other Colleges Dashboard</span>
                        </a>
                    </div>
                </div>
                <div>
                    <button onclick="logout()"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6 text-white">Other Colleges Registrations</h1>
        <div class="overflow-x-auto bg-white shadow-md rounded-lg">
            <table class="min-w-full table-auto">
                <thead class="bg-yellow-400">
                    <tr>
                        <th class="px-4 py-2 text-left">S.No</th>
                        <th class="px-4 py-2 text-left">Name</th>
                        <th class="px-4 py-2 text-left">Gender</th>
                        <th class="px-4 py-2 text-left">Contact</th>
                        <th class="px-4 py-2 text-left">Email</th>
                        <th class="px-4 py-2 text-left">College</th>
                        <th class="px-4 py-2 text-left">Course</th>
                        <th class="px-4 py-2 text-left">Year</th>
                        <th class="px-4 py-2 text-left">Zone</th>
                        <th class="px-4 py-2 text-left">Confirmation</th>
                        <th class="px-4 py-2 text-left">Mark Payment</th>
                        <th class="px-4 py-2 text-left">Amount Paid</th>
                        <th class="px-4 py-2 text-left">Action</th>
                    </tr>
                </thead>
                <tbody id="registrationData">
                    <!-- Data will be inserted here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // Firebase configuration (you'll need to fill this in with your actual config)
        const firebaseConfig = {
            // Your Firebase configuration here
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // List of colleges to include
        const includedColleges = [
            "anss-homeo-medical-college",
            "bishop-abraham-memorial-college",
            "biswas-college",
            "brilliant-college",
            "central-engineering-institute-malapally",
            "central-university-kerala",
            "christian-college",
            "college-of-engineering-alapuzha",
            "college-of-engineering-kaloopara",
            "deepthy-college",
            "fathima-college",
            "fr-porukara-college",
            "govt-iti-chengannur",
            "govt-womens-iti",
            "macfast-college",
            "maharajas-college",
            "mar-thoma-college",
            "mount-zion-institute",
            "nss-college",
            "nss-training-college",
            "providence-college",
            "sa-college",
            "sert-college",
            "shri-narayana-college",
            "st-marys-college",
            "st-theresa-teachers-institute",
            "st-john-baptist-college",
            "st-joseph-technology",
            "st-thomas-engineering",
            "st-thomas-nursing",
            "st-thomas-teacher-training",
            "titus-2-teachers-college",
            "ucte-paippad",
            "other"
            // Add more colleges as needed
        ];

        // Function to fetch and display data
        function fetchAndDisplayData() {
            const tableBody = document.getElementById('registrationData');

            // Create a query to fetch registrations for included colleges
            const query = db.collection("registrations")
                .where("college", "in", includedColleges);


            query
                .orderBy("timestamp", "asc") // Add this line to sort by timestamp in ascending order
                .get().then((querySnapshot) => {
                    tableBody.innerHTML = ''; // Clear existing data
                    let serialNumber = 1; // Initialize serial number
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const row = `
                        <tr class="border-b hover:bg-gray-50" id="row-${doc.id}">
                            <td class="px-4 py-2">${serialNumber}</td>
                            <td class="px-4 py-2">${data.name}</td>
                            <td class="px-4 py-2">${data.gender}</td>
                            <td class="px-4 py-2">${data.contactNumber}</td>
                            <td class="px-4 py-2">${data.email}</td>
                            <td class="px-4 py-2">${data.college}</td>
                            <td class="px-4 py-2">${data.course}</td>
                            <td class="px-4 py-2">${data.year}</td>
                            <td class="px-4 py-2">${data.zone}</td>
                            <td class="px-4 py-2">
                                <select class="border rounded px-2 py-1" id="confirmation-${doc.id}">
                                    <option value="">Select</option>
                                    <option value="Yes" ${data.confirmation === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${data.confirmation === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </td>
                            <td class="px-4 py-2">
                                <select class="border rounded px-2 py-1" id="paymentStatus-${doc.id}">
                                    <option value="">Select</option>
                                    <option value="Paid" ${data.paymentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                                    <option value="Unpaid" ${data.paymentStatus === 'Unpaid' ? 'selected' : ''}>Unpaid</option>
                                </select>
                            </td>
                            <td class="px-4 py-2">
                                <input type="number" class="border rounded px-2 py-1" id="amountPaid-${doc.id}" value="${data.amountPaid || ''}" placeholder="Amount">
                            </td>
                            <td class="px-4 py-2">
                                <button onclick="updateEntry('${doc.id}')" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded">
                                    Update
                                </button>
                            </td>
                        </tr>
                    `;
                        tableBody.innerHTML += row;
                        serialNumber++; // Increment serial number for next row
                    });
                }).catch((error) => {
                    console.error("Error fetching data: ", error);
                });
        }

        // Function to update an entry in Firestore
        function updateEntry(docId) {
            const confirmation = document.getElementById(`confirmation-${docId}`).value;
            const paymentStatus = document.getElementById(`paymentStatus-${docId}`).value;
            const amountPaid = document.getElementById(`amountPaid-${docId}`).value;

            db.collection("registrations").doc(docId).update({
                confirmation: confirmation,
                paymentStatus: paymentStatus,
                amountPaid: amountPaid
            }).then(() => {
                console.log("Document successfully updated!");
                alert("Entry updated successfully!");
            }).catch((error) => {
                console.error("Error updating document: ", error);
                alert("Error updating entry. Please try again.");
            });
        }

        // Function to handle logout
        function logout() {
            auth.signOut().then(() => {
                // Sign-out successful.
                alert("You have been logged out successfully.");
                // Redirect to login page
                window.location.href = "/otherslogin.html";
            }).catch((error) => {
                // An error happened.
                console.error("Error signing out: ", error);
                alert("Error logging out. Please try again.");
            });
        }

        // Replace the existing auth.onAuthStateChanged function with this:
        function checkAuth() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        db.collection("others").doc(user.email).get()
                            .then((doc) => {
                                if (doc.exists) {
                                    resolve(user);
                                } else {
                                    auth.signOut().then(() => {
                                        reject(new Error("User is not authorized"));
                                    });
                                }
                            })
                            .catch((error) => {
                                reject(error);
                            });
                    } else {
                        reject(new Error("No user is signed in"));
                    }
                });
            });
        }

        // Use an async IIFE to check auth state before proceeding
        (async () => {
            try {
                await checkAuth();
                fetchAndDisplayData();
            } catch (error) {
                console.error("Authentication error:", error);
                window.location.replace('/otherslogin.html');
            }
        })();
    </script>
</body>

</html>